generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}
enum UserRole {
  USER
  ADMIN
  SUPERADMIN
}

enum GroupStatus {
  complete
  pending
  rejected
}

enum MerchandiseSize {
  XS
  S
  M
  L
  XL
  XXL
  XXXL
  XXXXL
}

enum MerchandiseColor {
  BLACK
  WHITE
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
}

enum PaymentTargetType {
  WORKSHOP
  MERCHANDISE
}

enum Campus {
  JADAVPUR
  SALT_LAKE
}

/**
 * USER & AUTH
 */

model User {
  id                   String               @id @default(auto()) @map("_id") @db.ObjectId
  name                 String
  email                String               @unique
  image                String?
  password             String?
  phone                String?              @unique
  college              String?
  year                 String?
  department           String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  role                 UserRole             @default(USER)
  emailVerified        DateTime?
  registrationComplete Boolean              @default(false)
  verificationToken    String?
  passwordResetTokens  ResetPasswordToken[]

  accounts      Account[]
  notifications Notification[]
  merchandise   Merchandise[]

  teamIds            String[] @db.ObjectId
  teams              Team[]   @relation("UserTeams", fields: [teamIds], references: [id])
  pendingTeamIds     String[] @db.ObjectId
  pendingTeams       Team[]   @relation("UserPendingTeams", fields: [pendingTeamIds], references: [id])
  wishlistedEventIds String[] @db.ObjectId
  wishlist           Event[]  @relation("UserWishlistedEvents", fields: [wishlistedEventIds], references: [id])

  workshopIds String[]     @db.ObjectId
  workshops   Workshop[]   @relation(fields: [workshopIds], references: [id])
  payments    Payment[]    @relation("UserPayments")
  adminEvents EventAdmin[] @relation("AdminUserEvents")

  @@map("user")
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  token_type        String?
  refresh_token     String? @db.String
  access_token      String? @db.String
  id_token          String? @db.String
  scope             String?
  session_state     String?
  expires_at        Int?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  @@unique([provider, providerAccountId])
  @@map("account")
}

/**
 * NOTIFICATIONS
 */

model Notification {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification")
}

/**
 * MERCHANDISE
 */

model Merchandise {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  size            MerchandiseSize?
  color           MerchandiseColor?
  status          PaymentStatus?
  preferredCampus Campus            @default(JADAVPUR)

  userId   String    @db.ObjectId
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[] @relation("MerchPayments")

  @@index([userId])
  @@map("merchandise")
}

/**
 * EVENTS & TEAMS
 */

model Event {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  slug       String @unique
  name       String
  minMembers Int
  maxMembers Int

  isVisible        Boolean @default(true)
  registrationOpen Boolean @default(false)

  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  adminUsers EventAdmin[] @relation("AdminEventUsers")
  teams      Team[]

  wishlistedByIds String[] @db.ObjectId
  wishlistedBy    User[]   @relation("UserWishlistedEvents", fields: [wishlistedByIds], references: [id])
}

model EventAdmin {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  eventId String @db.ObjectId
  userId  String @db.ObjectId

  event Event @relation("AdminEventUsers", fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation("AdminUserEvents", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_admin")
}

model Team {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  name             String
  eventSlug        String
  event            Event    @relation(fields: [eventSlug], references: [slug], onDelete: Cascade)
  memberIds        String[] @db.ObjectId
  members          User[]   @relation("UserTeams", fields: [memberIds], references: [id])
  pendingMemberIds String[] @db.ObjectId
  pendingMembers   User[]   @relation("UserPendingTeams", fields: [pendingMemberIds], references: [id])
  leader           String   @db.ObjectId
  joiningCode      String   @unique

  @@map("team")
}

/**
 * WORKSHOPS
 */

model Workshop {
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  slug  String @unique
  name  String
  price Float

  payments    Payment[] @relation("WorkshopPayments")
  attendeeIds String[]  @db.ObjectId
  attendees   User[]    @relation(fields: [attendeeIds], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workshop")
}

/**
 * PAYMENTS
 */

model Payment {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  amount        Float
  paymentDate   DateTime          @default(now())
  transactionId String            @unique
  status        PaymentStatus
  targetType    PaymentTargetType

  userId String @db.ObjectId
  user   User   @relation("UserPayments", fields: [userId], references: [id], onDelete: Cascade)

  workshopId String?   @db.ObjectId
  workshop   Workshop? @relation("WorkshopPayments", fields: [workshopId], references: [id])

  merchandiseId String?      @db.ObjectId
  merchandise   Merchandise? @relation("MerchPayments", fields: [merchandiseId], references: [id])

  @@index([userId])
  @@index([workshopId])
  @@index([merchandiseId])
  @@map("payment")
}

/**
 * PASSWORD RESET
 */

model ResetPasswordToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  user_id   String   @db.ObjectId
  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  expiresAt DateTime

  @@map("reset_password_token")
}

/**
 * CAMPUS AMBASSADOR
 */

model CampusAmbassador {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  college       String
  referralCode  String @unique
  referralCount Int    @default(0)
}
